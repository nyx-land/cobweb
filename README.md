- [Cobweb ðŸ•¸](#org9fe2fd4)
  - [Why would I want this?](#orgb0aae2c)
  - [Installation](#orga6dd457)
  - [Usage](#org8bf8eaa)
- [A Note on `COBWEB-GEN`](#org5f6a2c0)
- [Potential Improvements](#orgecda9eb)


<a id="org9fe2fd4"></a>

# Cobweb ðŸ•¸

Cobweb is yet another sexp->HTML emitter library for Common Lisp, but also much more.

Unlike the other sexp emitters that currently exist for CL, Cobweb isn't just a more convenient syntax for writing HTML using macros. It's also a full mapping of CLOS to the W3 specification for HTML, autogenerated using the `COBWEB-GEN` system. This means that when using Cobweb to write HTML, you're not just working with plain lists, but rather have the full power of CLOS and the MOP at your disposal to do whatever you want with the DOM.

Cobweb also has the advantage of being generated from the W3 spec rather than at the discretion of the implementer or by relying on a simple non-validating macro system. It turns out that it's rather trivial to do this thanks to the machine-readable version that W3 provides, and with how important backwards-compatibility is for the web it's unlikely that it'll change drastically anytime soon.


<a id="orgb0aae2c"></a>

## Why would I want this?

You may not have any use case for this and be better off with Spinneret or CL-WHO, but for my own purposes, I wanted to be able to implement some fancy features for Cobweb's sister project Widow and being able to use the MOP seemed like the best way to do it.


<a id="orga6dd457"></a>

## Installation

You will need to clone this [somewhere that ASDF can find it](https://asdf.common-lisp.dev/asdf.html#Configuring-ASDF-to-find-your-systems), unless I decide this project is good enough to submit to Quicklisp.


<a id="org8bf8eaa"></a>

## Usage

Cobweb exports two macros, `WITH-HTML` and `WITH-HTML-WRITE`, along with all the classes and accessors and the writer function `HTML-WRITER`. `WITH-HTML` will just return the CLOS standard-objects, while `WITH-HTML-WRITE` can be used to write to stdout, a string, or a file, and also return the standard-objects if desired.

`WITH-HTML` just takes an s-expression `(&BODY BODY)` representing an HTML fragment and returns the element(s) as a vector of standard-objects

`WITH-HTML-WRITE` also accepts `STREAM`. `STREAM` takes the same arguments as `FORMAT`: `NIL` returns a string, `T` prints to stdout, or otherwise it can be any other stream. It will return the written HTML and the objects.

```common-lisp
CL-USER> (ql:quickload :cobweb)
To load "cobweb":
  Load 1 ASDF system:
    cobweb
; Loading "cobweb"
[package cobweb]..

(:COBWEB)
CL-USER> (describe 'cobweb:with-html)
COBWEB:WITH-HTML
  [symbol]

WITH-HTML names a macro:
  Lambda-list: (&BODY BODY)
  Source file: cl/cobweb/src/cobweb.lisp

; No values
CL-USER> (describe 'cobweb:with-html-write)
COBWEB:WITH-HTML-WRITE
  [symbol]

WITH-HTML-WRITE names a macro:
  Lambda-list: (STREAM RETURN &BODY BODY)
  Source file: cl/cobweb/src/cobweb.lisp
```

Here's an example that prints to stdout and returns the objects:

```common-lisp
CL-USER> (let ((css #P"/static/css/style.css")
               (lyrics (uiop:split-string
                        (alexandria:read-file-into-string #P"~/lyrics.txt")
                        :separator '(#\newline))))
           (cobweb:with-html-write t
             (html
              (head
               ;; you can reference variables from outside the scope
               ;; and even evaluate functions whose output will be
               ;; interpreted as HTML
               (link :rel "stylesheet" :href (namestring css))
               (meta :name "viewport" :content "width=device-width, initial-scale=1.0")
               (title "Spiders"))
              (body
               (h1 "Time moves like spiders")
               (let ((lyric-list (ol
                                  ;; and you can generate elements from arbitrary functions
                                  (loop for line in lyrics
                                        collect (li line)))))
                 ;; you can even set the attribute of an element
                 ;; from within the `WITH-HTML' form the same way
                 ;; you would with any other object

                 lyric-list)))))
<html>
  <head>
    <link href="/static/css/style.css" rel="stylesheet">
    </link>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    </meta>
    <title>
      Spiders
    </title>
  </head>
  <body>
    <h1>
      Time moves like spiders
    </h1>
    <ol class="lyrics">
      <li>
        Time moves like spiders
      </li>
      <li>
        Over the face of the clock
      </li>
      <li>
        Time's forward violence
      </li>
      <li>
        Eating away at the heart
      </li>
      <li>

      </li>
      <li>
        Another hour's past
      </li>
      <li>
        They never seem to last
      </li>
      <li>
        Another day goes by
      </li>
      <li>
        No matter how I try
      </li>
      <li>

      </li>
    </ol>
  </body>
</html>
#(#<HTML
         #(#<HEAD #(#<LINK #()> #<META #()> #<TITLE #(Spiders)>)>
           #<BODY
                  #(#<H1 #(Time moves like spiders)>
                    #<OL :CLASS "lyrics"
                                         #((#<LI #(Time moves like spiders)>
                                            #<LI #(Over the face of the clock)>
                                            #<LI #(Time's forward violence)>
                                            #<LI #(Eating away at the heart)>
                                            #<LI #()>
                                            #<LI #(Another hour's past)>
                                            #<LI #(They never seem to last)>
                                            #<LI #(Another day goes by)>
                                            #<LI #(No matter how I try)>
                                            #<LI #()>))>)>)>)
NIL
CL-USER>
```

`HTML-WRITER` is a method and can be customized like any other method to control how the HTML is printed. By default it'll pretty-print as best I could figure out how to do using `FORMAT`.


<a id="org5f6a2c0"></a>

# A Note on `COBWEB-GEN`

`COBWEB-GEN` does technically work but it's still pretty hacky and bad so I wouldn't recommend touching it right now. However, if you really must regenerate the spec (if perhaps you've made changes to `spec-src.lisp` or `package-src.lisp`), you can do the following:

```common-lisp
CL-USER> (ql:quickload :cobweb-gen)
To load "cobweb-gen":
  Load 1 ASDF system:
    cobweb-gen
; Loading "cobweb-gen"
..................
(:COBWEB-GEN)
CL-USER> (in-package :cobweb-gen)
#<PACKAGE "COBWEB-GEN">
COBWEB-GEN> (write-files (get-spec))
T
```


<a id="orgecda9eb"></a>

# Potential Improvements

-   Fix `COBWEB-GEN` bugs
-   Add some utilities to walk through the DOM
